<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="style.css">
</head>

<body onload="loadScript()">
    <div class="wrapper">
        <div class="box">
            <canvas id="tool_render_canvas" tabindex="-1" onclick="focus_canvas()"></canvas>
        </div>
        <div class="handler"></div>
        <div class="box">
            <div id="tool_shader_div">
                <div>
                    <textarea id="edit_shader_tool_shader_text" tabindex="0"></textarea>
                </div>
                <div id="tool_shader_settings">
                    <button id="update_shader" onclick="update_shader()">Update Shader</button>
                    <button id="update_settings" onclick="update_settings()">Update Settings</button>
                    <div>
                        <label>Wave Amplitude:</label>
                        <input type="number" id="in_wave_amplitude" min="0.0" value="0.0005" step="0.0001" required>
                    </div>
                    <div>
                        <label>Wave Resolution:</label>
                        <input type="number" id="in_wave_resolution" min="0.1" value="0.5" step="0.1" required>
                    </div>
                    <div>
                        <label>Wind Speed X:</label>
                        <input type="number" id="in_wind_speed_x" value="0.0" step="1.0" required>
                    </div>
                    <div>
                        <label>Wind Speed Z:</label>
                        <input type="number" id="in_wind_speed_z" value="32.0" step="1.0" required>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var handler = document.querySelector('.handler');
        var wrapper = handler.closest('.wrapper');
        var boxA = wrapper.querySelector('.box');
        var isHandlerDragging = false;

        document.addEventListener('mousedown', function (e) {
            if (e.target === handler) {
                isHandlerDragging = true;
            }
        });

        document.addEventListener('mousemove', function (e) {
            // Debounce
            if (!isHandlerDragging) {
                return;
            }
            var containerOffsetLeft = wrapper.offsetLeft;
            var pointerRelativeXpos = e.clientX - containerOffsetLeft;
            var boxAminWidth = 60;
            boxA.style.width = (Math.max(boxAminWidth, pointerRelativeXpos - 8)) + 'px';
            boxA.style.flexGrow = 0;
        });

        document.addEventListener('mouseup', function (e) {
            // Debounce
            if (!isHandlerDragging) {
                return;
            }
            isHandlerDragging = false;
            var canvas = document.getElementById("tool_render_canvas");
            canvas.width = boxA.clientWidth;
            canvas.height = boxA.clientHeight;
            window.dispatchEvent(new Event('resize'));
        });

        function loadScript() {
            Module = {};
            Module.preRun = new Array();
            Module.preRun.push(function () {
                ENV.SDL_EMSCRIPTEN_KEYBOARD_ELEMENT = "#canvas";
            });

            // Load the demo script
            var script = document.createElement("script");
            script.src = "bin/index.js";
            script.onload = function () {
                var canvas = document.getElementById("tool_render_canvas");
                canvas.width = boxA.clientWidth;
                canvas.height = boxA.clientHeight;
                Module.canvas = canvas;
            }
            document.body.appendChild(script);
        }

        // Pointer to the rendering context
        var last_context_ptr = 0;

        // This function is called once after initialization
        function context_on_init_js(context_ptr) {
            // Save the frame pointer
            last_context_ptr = context_ptr;

            // Initialize the text editor
            document.getElementById("edit_shader_tool_shader_text").value = Module.get_fragment_source();

            // Trigger window resize
            window.dispatchEvent(new Event('resize'));
        }

        // This function is called every frame
        function context_on_frame_js(context_ptr) {
            // Save the frame pointer
            last_context_ptr = context_ptr;
        }

        function focus_canvas() {
            document.getElementById("tool_render_canvas").focus()
        }

        function update_settings() {
            // Update the wave settings
            let wave_amplitude = Number(document.getElementById("in_wave_amplitude").value);
            let wave_resolution = Number(document.getElementById("in_wave_resolution").value);
            let wind_speed_x = Number(document.getElementById("in_wind_speed_x").value);
            let wind_speed_z = Number(document.getElementById("in_wind_speed_z").value);
            Module.update_water_settings(last_context_ptr, wave_amplitude, wave_resolution, wind_speed_x, wind_speed_z);
        }
        function update_shader() {
            Module.recompile_program(last_context_ptr, document.getElementById("edit_shader_tool_shader_text").value);
        }
    </script>
</body>

</html>
